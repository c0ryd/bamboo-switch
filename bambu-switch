#!/bin/bash
#
# bambu-switch - Bambu Studio Profile Manager
# 
# Manages multiple Bambu Studio profiles by swapping symlinks,
# allowing you to maintain separate logins without re-authenticating.
#

set -e

SUPPORT_DIR="$HOME/Library/Application Support"
BAMBU_LINK="$SUPPORT_DIR/BambuStudio"
PROFILE_PREFIX="BambuStudio-"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_error() {
    echo -e "${RED}Error:${NC} $1" >&2
}

print_success() {
    echo -e "${GREEN}$1${NC}"
}

print_info() {
    echo -e "${BLUE}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}$1${NC}"
}

# Check if BambuStudio is running
check_not_running() {
    if pgrep -x "BambuStudio" > /dev/null; then
        print_error "BambuStudio is running. Please quit it first."
        exit 1
    fi
}

# Get the current active profile name
get_current_profile() {
    if [ -L "$BAMBU_LINK" ]; then
        target=$(readlink "$BAMBU_LINK")
        basename "$target" | sed "s/^$PROFILE_PREFIX//"
    elif [ -d "$BAMBU_LINK" ]; then
        echo "(not managed - regular directory)"
    else
        echo "(none)"
    fi
}

# List all available profiles
cmd_list() {
    current=$(get_current_profile)
    echo "Available profiles:"
    echo ""
    
    found=0
    for dir in "$SUPPORT_DIR"/${PROFILE_PREFIX}*; do
        if [ -d "$dir" ]; then
            found=1
            name=$(basename "$dir" | sed "s/^$PROFILE_PREFIX//")
            if [ "$name" = "$current" ]; then
                echo -e "  ${GREEN}* $name${NC} (active)"
            else
                echo "    $name"
            fi
        fi
    done
    
    if [ $found -eq 0 ]; then
        print_warning "  No profiles found. Run 'bambu-switch init' to get started."
    fi
}

# Create a new profile
cmd_create() {
    local name="$1"
    
    if [ -z "$name" ]; then
        print_error "Profile name required."
        echo "Usage: bambu-switch create <profile-name>"
        exit 1
    fi
    
    # Validate name (alphanumeric, dash, underscore only)
    if [[ ! "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        print_error "Profile name can only contain letters, numbers, dashes, and underscores."
        exit 1
    fi
    
    local profile_dir="$SUPPORT_DIR/${PROFILE_PREFIX}${name}"
    
    if [ -d "$profile_dir" ]; then
        print_error "Profile '$name' already exists."
        exit 1
    fi
    
    mkdir -p "$profile_dir"
    print_success "Created profile '$name'"
    echo ""
    echo "To use it, run: bambu-switch $name"
}

# Delete a profile
cmd_delete() {
    local name="$1"
    
    if [ -z "$name" ]; then
        print_error "Profile name required."
        echo "Usage: bambu-switch delete <profile-name>"
        exit 1
    fi
    
    local profile_dir="$SUPPORT_DIR/${PROFILE_PREFIX}${name}"
    
    if [ ! -d "$profile_dir" ]; then
        print_error "Profile '$name' does not exist."
        exit 1
    fi
    
    current=$(get_current_profile)
    if [ "$name" = "$current" ]; then
        print_error "Cannot delete the active profile. Switch to another profile first."
        exit 1
    fi
    
    echo "This will permanently delete profile '$name' and all its data."
    read -p "Are you sure? (y/N) " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$profile_dir"
        print_success "Deleted profile '$name'"
    else
        echo "Cancelled."
    fi
}

# Switch to a profile
cmd_switch() {
    local name="$1"
    
    if [ -z "$name" ]; then
        print_error "Profile name required."
        echo "Usage: bambu-switch <profile-name>"
        exit 1
    fi
    
    local profile_dir="$SUPPORT_DIR/${PROFILE_PREFIX}${name}"
    
    if [ ! -d "$profile_dir" ]; then
        print_error "Profile '$name' does not exist."
        echo ""
        echo "Available profiles:"
        for dir in "$SUPPORT_DIR"/${PROFILE_PREFIX}*; do
            if [ -d "$dir" ]; then
                echo "  - $(basename "$dir" | sed "s/^$PROFILE_PREFIX//")"
            fi
        done
        echo ""
        echo "Create a new profile with: bambu-switch create $name"
        exit 1
    fi
    
    check_not_running
    
    # Remove existing symlink or backup existing directory
    if [ -L "$BAMBU_LINK" ]; then
        rm -f "$BAMBU_LINK"
    elif [ -d "$BAMBU_LINK" ]; then
        print_error "BambuStudio directory exists but is not a symlink."
        echo "Run 'bambu-switch init' to migrate your existing config to a profile."
        exit 1
    fi
    
    ln -s "$profile_dir" "$BAMBU_LINK"
    print_success "Switched to profile '$name'"
}

# Show current status
cmd_status() {
    current=$(get_current_profile)
    echo "Current profile: $current"
    
    if [ -L "$BAMBU_LINK" ]; then
        echo "Config path: $(readlink "$BAMBU_LINK")"
    fi
}

# Initialize - migrate existing config to a profile
cmd_init() {
    local name="${1:-default}"
    
    echo "Bambu Switch Setup"
    echo "=================="
    echo ""
    
    # Check if already initialized
    if [ -L "$BAMBU_LINK" ]; then
        print_info "Already initialized."
        cmd_list
        return 0
    fi
    
    # Check if BambuStudio directory exists
    if [ -d "$BAMBU_LINK" ]; then
        check_not_running
        
        echo "Found existing BambuStudio config."
        read -p "Migrate it to profile '$name'? (Y/n) " -n 1 -r
        echo
        
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            local profile_dir="$SUPPORT_DIR/${PROFILE_PREFIX}${name}"
            mv "$BAMBU_LINK" "$profile_dir"
            ln -s "$profile_dir" "$BAMBU_LINK"
            print_success "Migrated existing config to profile '$name'"
        else
            echo "Cancelled. Run init again when ready."
            return 1
        fi
    else
        # No existing config, create fresh
        print_info "No existing BambuStudio config found."
        cmd_create "$name"
        cmd_switch "$name"
    fi
    
    echo ""
    print_success "Setup complete!"
    echo ""
    echo "Quick start:"
    echo "  bambu-switch list           # Show all profiles"
    echo "  bambu-switch create work    # Create a new profile"
    echo "  bambu-switch work           # Switch to profile"
    echo "  bambu-switch status         # Show current profile"
}

# Show help
cmd_help() {
    echo "bambu-switch - Bambu Studio Profile Manager"
    echo ""
    echo "Usage: bambu-switch <command> [arguments]"
    echo ""
    echo "Commands:"
    echo "  <profile>           Switch to the specified profile"
    echo "  list                List all available profiles"
    echo "  create <name>       Create a new profile"
    echo "  delete <name>       Delete a profile (with confirmation)"
    echo "  status              Show current active profile"
    echo "  init [name]         Initialize (migrate existing config to profile)"
    echo "  help                Show this help message"
    echo ""
    echo "Examples:"
    echo "  bambu-switch init           # First-time setup"
    echo "  bambu-switch create work    # Create a 'work' profile"
    echo "  bambu-switch work           # Switch to 'work' profile"
    echo "  bambu-switch home           # Switch back to 'home' profile"
    echo ""
    echo "Note: BambuStudio must be closed before switching profiles."
}

# Main command dispatcher
case "${1:-}" in
    list|ls)
        cmd_list
        ;;
    create|new|add)
        cmd_create "$2"
        ;;
    delete|rm|remove)
        cmd_delete "$2"
        ;;
    status)
        cmd_status
        ;;
    init|setup)
        cmd_init "$2"
        ;;
    help|--help|-h)
        cmd_help
        ;;
    "")
        cmd_help
        ;;
    *)
        # Assume it's a profile name to switch to
        cmd_switch "$1"
        ;;
esac
