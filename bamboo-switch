#!/bin/bash
#
# bamboo-switch - Bambu Studio Profile Manager
# 
# Manages multiple Bambu Studio profiles by swapping symlinks,
# allowing you to maintain separate logins without re-authenticating.
#

set -e

SUPPORT_DIR="$HOME/Library/Application Support"
BAMBU_LINK="$SUPPORT_DIR/BambuStudio"
PROFILE_PREFIX="BambuStudio-"
CONFIG_FILE="BambuStudio.conf"
SYNC_RECENTS=true  # Set to false to disable recent files sync

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_error() {
    echo -e "${RED}Error:${NC} $1" >&2
}

print_success() {
    echo -e "${GREEN}$1${NC}"
}

print_info() {
    echo -e "${BLUE}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}$1${NC}"
}

# Check if BambuStudio is running
is_bambu_running() {
    pgrep -x "BambuStudio" > /dev/null
}

# Quit BambuStudio gracefully
quit_bambu() {
    if ! is_bambu_running; then
        return 0
    fi
    
    print_info "Closing BambuStudio..."
    osascript -e 'tell application "BambuStudio" to quit' 2>/dev/null || true
    
    # Wait for it to quit
    for i in {1..10}; do
        if ! is_bambu_running; then
            return 0
        fi
        sleep 0.5
    done
    
    # Force kill if still running
    killall BambuStudio 2>/dev/null || true
    sleep 0.5
    
    ! is_bambu_running
}

# Launch BambuStudio
launch_bambu() {
    print_info "Launching BambuStudio..."
    open "/Applications/BambuStudio.app"
}

# Sync recent files between profiles using Python (for JSON parsing)
sync_recent_files() {
    local from_profile="$1"
    local to_profile="$2"
    
    if [ "$SYNC_RECENTS" != "true" ]; then
        return 0
    fi
    
    local from_config="$SUPPORT_DIR/${PROFILE_PREFIX}${from_profile}/$CONFIG_FILE"
    local to_config="$SUPPORT_DIR/${PROFILE_PREFIX}${to_profile}/$CONFIG_FILE"
    
    if [ ! -f "$from_config" ] || [ ! -f "$to_config" ]; then
        return 0
    fi
    
    # Use Python for reliable JSON manipulation
    python3 << EOF 2>/dev/null || true
import json

try:
    with open("$from_config", 'r') as f:
        from_data = json.load(f)
    with open("$to_config", 'r') as f:
        to_data = json.load(f)
    
    # Copy recent files sections
    if "recent" in from_data:
        to_data["recent"] = from_data["recent"]
    if "recent_projects" in from_data:
        to_data["recent_projects"] = from_data["recent_projects"]
    
    with open("$to_config", 'w') as f:
        json.dump(to_data, f, indent=4)
except:
    pass
EOF
}

# Get the current active profile name
get_current_profile() {
    if [ -L "$BAMBU_LINK" ]; then
        target=$(readlink "$BAMBU_LINK")
        basename "$target" | sed "s/^$PROFILE_PREFIX//"
    elif [ -d "$BAMBU_LINK" ]; then
        echo "(not managed - regular directory)"
    else
        echo "(none)"
    fi
}

# List all available profiles
cmd_list() {
    current=$(get_current_profile)
    echo "Available profiles:"
    echo ""
    
    found=0
    for dir in "$SUPPORT_DIR"/${PROFILE_PREFIX}*; do
        if [ -d "$dir" ]; then
            found=1
            name=$(basename "$dir" | sed "s/^$PROFILE_PREFIX//")
            if [ "$name" = "$current" ]; then
                echo -e "  ${GREEN}* $name${NC} (active)"
            else
                echo "    $name"
            fi
        fi
    done
    
    if [ $found -eq 0 ]; then
        print_warning "  No profiles found. Run 'bamboo-switch init' to get started."
    fi
}

# Create a new profile
cmd_create() {
    local name="$1"
    
    if [ -z "$name" ]; then
        print_error "Profile name required."
        echo "Usage: bamboo-switch create <profile-name>"
        exit 1
    fi
    
    # Validate name (alphanumeric, dash, underscore only)
    if [[ ! "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        print_error "Profile name can only contain letters, numbers, dashes, and underscores."
        exit 1
    fi
    
    local profile_dir="$SUPPORT_DIR/${PROFILE_PREFIX}${name}"
    
    if [ -d "$profile_dir" ]; then
        print_error "Profile '$name' already exists."
        exit 1
    fi
    
    mkdir -p "$profile_dir"
    print_success "Created profile '$name'"
    echo ""
    echo "To use it, run: bamboo-switch $name"
}

# Delete a profile
cmd_delete() {
    local name="$1"
    
    if [ -z "$name" ]; then
        print_error "Profile name required."
        echo "Usage: bamboo-switch delete <profile-name>"
        exit 1
    fi
    
    local profile_dir="$SUPPORT_DIR/${PROFILE_PREFIX}${name}"
    
    if [ ! -d "$profile_dir" ]; then
        print_error "Profile '$name' does not exist."
        exit 1
    fi
    
    current=$(get_current_profile)
    if [ "$name" = "$current" ]; then
        print_error "Cannot delete the active profile. Switch to another profile first."
        exit 1
    fi
    
    echo "This will permanently delete profile '$name' and all its data."
    read -p "Are you sure? (y/N) " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$profile_dir"
        print_success "Deleted profile '$name'"
    else
        echo "Cancelled."
    fi
}

# Switch to a profile
cmd_switch() {
    local name="$1"
    
    if [ -z "$name" ]; then
        print_error "Profile name required."
        echo "Usage: bamboo-switch <profile-name>"
        exit 1
    fi
    
    local profile_dir="$SUPPORT_DIR/${PROFILE_PREFIX}${name}"
    
    if [ ! -d "$profile_dir" ]; then
        print_error "Profile '$name' does not exist."
        echo ""
        echo "Available profiles:"
        for dir in "$SUPPORT_DIR"/${PROFILE_PREFIX}*; do
            if [ -d "$dir" ]; then
                echo "  - $(basename "$dir" | sed "s/^$PROFILE_PREFIX//")"
            fi
        done
        echo ""
        echo "Create a new profile with: bamboo-switch create $name"
        exit 1
    fi
    
    # Check if already on this profile
    current=$(get_current_profile)
    if [ "$name" = "$current" ]; then
        print_info "Already on profile '$name'"
        if ! is_bambu_running; then
            launch_bambu
        fi
        exit 0
    fi
    
    # Auto-close BambuStudio if running
    if is_bambu_running; then
        if ! quit_bambu; then
            print_error "Could not close BambuStudio. Please close it manually."
            exit 1
        fi
    fi
    
    # Sync recent files from current profile before switching
    if [ -n "$current" ] && [ "$current" != "(none)" ] && [ "$current" != "(not managed - regular directory)" ]; then
        sync_recent_files "$current" "$name"
    fi
    
    # Remove existing symlink or backup existing directory
    if [ -L "$BAMBU_LINK" ]; then
        rm -f "$BAMBU_LINK"
    elif [ -d "$BAMBU_LINK" ]; then
        print_error "BambuStudio directory exists but is not a symlink."
        echo "Run 'bamboo-switch init' to migrate your existing config to a profile."
        exit 1
    fi
    
    ln -s "$profile_dir" "$BAMBU_LINK"
    print_success "Switched to profile '$name'"

# Note: This tool manages Bambu Studio profiles but is not affiliated with Bambu Lab
    
    # Auto-launch BambuStudio
    launch_bambu
}

# Show current status
cmd_status() {
    current=$(get_current_profile)
    echo "Current profile: $current"
    
    if [ -L "$BAMBU_LINK" ]; then
        echo "Config path: $(readlink "$BAMBU_LINK")"
    fi
}

# Initialize - migrate existing config to a profile
cmd_init() {
    local name="${1:-default}"
    
    echo "Bambu Switch Setup"
    echo "=================="
    echo ""
    
    # Check if already initialized
    if [ -L "$BAMBU_LINK" ]; then
        print_info "Already initialized."
        cmd_list
        return 0
    fi
    
    # Check if BambuStudio directory exists
    if [ -d "$BAMBU_LINK" ]; then
        check_not_running
        
        echo "Found existing BambuStudio config."
        read -p "Migrate it to profile '$name'? (Y/n) " -n 1 -r
        echo
        
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            local profile_dir="$SUPPORT_DIR/${PROFILE_PREFIX}${name}"
            mv "$BAMBU_LINK" "$profile_dir"
            ln -s "$profile_dir" "$BAMBU_LINK"
            print_success "Migrated existing config to profile '$name'"
        else
            echo "Cancelled. Run init again when ready."
            return 1
        fi
    else
        # No existing config, create fresh
        print_info "No existing BambuStudio config found."
        cmd_create "$name"
        cmd_switch "$name"
    fi
    
    echo ""
    print_success "Setup complete!"
    echo ""
    echo "Quick start:"
    echo "  bamboo-switch list           # Show all profiles"
    echo "  bamboo-switch create work    # Create a new profile"
    echo "  bamboo-switch work           # Switch to profile"
    echo "  bamboo-switch status         # Show current profile"
}

# Show help
cmd_help() {
    echo "bamboo-switch - Bambu Studio Profile Manager"
    echo ""
    echo "Usage: bamboo-switch <command> [arguments]"
    echo ""
    echo "Commands:"
    echo "  <profile>           Switch to the specified profile"
    echo "  list                List all available profiles"
    echo "  create <name>       Create a new profile"
    echo "  delete <name>       Delete a profile (with confirmation)"
    echo "  status              Show current active profile"
    echo "  init [name]         Initialize (migrate existing config to profile)"
    echo "  help                Show this help message"
    echo ""
    echo "Examples:"
    echo "  bamboo-switch init           # First-time setup"
    echo "  bamboo-switch create work    # Create a 'work' profile"
    echo "  bamboo-switch work           # Switch to 'work' profile"
    echo "  bamboo-switch home           # Switch back to 'home' profile"
    echo ""
    echo "Note: BambuStudio must be closed before switching profiles."
}

# Main command dispatcher
case "${1:-}" in
    list|ls)
        cmd_list
        ;;
    create|new|add)
        cmd_create "$2"
        ;;
    delete|rm|remove)
        cmd_delete "$2"
        ;;
    status)
        cmd_status
        ;;
    init|setup)
        cmd_init "$2"
        ;;
    help|--help|-h)
        cmd_help
        ;;
    "")
        cmd_help
        ;;
    *)
        # Assume it's a profile name to switch to
        cmd_switch "$1"
        ;;
esac
